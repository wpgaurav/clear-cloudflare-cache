"use strict";var w=Object.defineProperty;var C=Object.getOwnPropertyDescriptor;var $=Object.getOwnPropertyNames;var F=Object.prototype.hasOwnProperty;var v=(r,t)=>{for(var n in t)w(r,n,{get:t[n],enumerable:!0})},I=(r,t,n,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of $(t))!F.call(r,a)&&a!==n&&w(r,a,{get:()=>t[a],enumerable:!(i=C(t,a))||i.enumerable});return r};var j=r=>I(w({},"__esModule",{value:!0}),r);var O={};v(O,{default:()=>E});module.exports=j(O);var e=require("@raycast/api"),p=require("react");var g=require("@raycast/api"),R="https://api.cloudflare.com/client/v4";function P(){let{apiToken:r}=(0,g.getPreferenceValues)();return{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}}async function L(){try{let t=await(await fetch(`${R}/zones?per_page=50`,{method:"GET",headers:P()})).json();if(!t.success){let n=t.errors.map(i=>i.message).join(", ");throw new Error(n||"Failed to fetch zones")}return t.result}catch(r){throw console.error("Error fetching zones:",r),r}}async function b(r,t){if(t.length===0)throw new Error("No URLs provided");if(t.length>30)throw new Error("Maximum 30 URLs per request. Split into multiple batches.");try{let i=await(await fetch(`${R}/zones/${r}/purge_cache`,{method:"POST",headers:P(),body:JSON.stringify({files:t})})).json();if(!i.success){let a=i.errors.map(h=>h.message).join(", ");throw new Error(a||"Failed to purge URLs")}return!0}catch(n){throw console.error("Error purging URLs:",n),n}}function S(r){try{return new URL(r).hostname}catch{return null}}async function y(r,t){await(0,g.showToast)({style:g.Toast.Style.Failure,title:r,message:t?.message})}async function x(r){await(0,g.showToast)({style:g.Toast.Style.Success,title:r})}var o=require("react/jsx-runtime");function E(){let[r,t]=(0,p.useState)([]),[n,i]=(0,p.useState)(!0),{push:a}=(0,e.useNavigation)();(0,p.useEffect)(()=>{h()},[]);async function h(){i(!0);try{let s=await L();t(s)}catch(s){await y("Failed to load zones",s instanceof Error?s:void 0)}finally{i(!1)}}function f(s){return s.paused?{source:e.Icon.Pause,tintColor:e.Color.Orange}:s.status==="active"?{source:e.Icon.CheckCircle,tintColor:e.Color.Green}:{source:e.Icon.Circle,tintColor:e.Color.SecondaryText}}return(0,o.jsx)(e.List,{isLoading:n,searchBarPlaceholder:"Select a zone to purge URLs from...",children:(0,o.jsx)(e.List.Section,{title:"Select Zone",subtitle:"Choose the site to purge URLs from",children:r.map(s=>(0,o.jsx)(e.List.Item,{title:s.name,subtitle:s.id,icon:f(s),accessories:[{tag:{value:s.status,color:s.status==="active"?e.Color.Green:e.Color.SecondaryText}}],actions:(0,o.jsxs)(e.ActionPanel,{children:[(0,o.jsx)(e.Action,{title:"Enter URLs to Purge",icon:e.Icon.List,onAction:()=>a((0,o.jsx)(A,{zone:s}))}),(0,o.jsx)(e.Action,{title:"Refresh Zones",icon:e.Icon.ArrowClockwise,shortcut:{modifiers:["cmd"],key:"r"},onAction:h})]})},s.id))})})}function A({zone:r}){let[t,n]=(0,p.useState)(""),[i,a]=(0,p.useState)(!1),[h,f]=(0,p.useState)(),{pop:s}=(0,e.useNavigation)();function T(m){let l=m.split(`
`).map(c=>c.trim()).filter(c=>c.length>0),d=[],u=[];for(let c of l)try{let U=new URL(c);U.protocol==="http:"||U.protocol==="https:"?d.push(c):u.push(c)}catch{u.push(c)}return u.length>0?f(`Invalid URLs: ${u.slice(0,3).join(", ")}${u.length>3?"...":""}`):f(void 0),d}async function Z(m){let l=T(m.urls);if(l.length===0){f("Please enter at least one valid URL");return}if(l.length>30){f("Maximum 30 URLs per request. Please reduce the number of URLs.");return}let d=l.filter(u=>{let c=S(u);return c?!c.endsWith(r.name)&&c!==r.name:!0});if(d.length>0){f(`Some URLs don't belong to ${r.name}: ${d[0]}`);return}a(!0),await(0,e.showToast)({style:e.Toast.Style.Animated,title:"Purging URLs...",message:`${l.length} URL(s)`});try{await b(r.id,l),await x(`Purged ${l.length} URL(s) from ${r.name}`),s()}catch(u){await y("Failed to purge URLs",u instanceof Error?u:void 0)}finally{a(!1)}}return(0,o.jsxs)(e.Form,{isLoading:i,actions:(0,o.jsx)(e.ActionPanel,{children:(0,o.jsx)(e.Action.SubmitForm,{title:"Purge URLs",icon:{source:e.Icon.Trash,tintColor:e.Color.Red},onSubmit:Z})}),children:[(0,o.jsx)(e.Form.Description,{title:"Zone",text:r.name}),(0,o.jsx)(e.Form.TextArea,{id:"urls",title:"URLs to Purge",placeholder:`https://${r.name}/page-1
https://${r.name}/page-2
https://${r.name}/css/style.css`,info:"Enter one URL per line. Maximum 30 URLs per request. URLs must include the full path including https://",value:t,onChange:n,error:h}),(0,o.jsx)(e.Form.Description,{title:"Tips",text:`\u2022 Include query strings if the cached URL has them
\u2022 Use exact URLs as they appear in browser
\u2022 For cache tags or prefix purge, use Quick Purge command`})]})}
