"use strict";var R=Object.defineProperty;var N=Object.getOwnPropertyDescriptor;var v=Object.getOwnPropertyNames;var M=Object.prototype.hasOwnProperty;var B=(t,o)=>{for(var n in o)R(t,n,{get:o[n],enumerable:!0})},J=(t,o,n,i)=>{if(o&&typeof o=="object"||typeof o=="function")for(let s of v(o))!M.call(t,s)&&s!==n&&R(t,s,{get:()=>o[s],enumerable:!(i=N(o,s))||i.enumerable});return t};var q=t=>J(R({},"__esModule",{value:!0}),t);var G={};B(G,{default:()=>$});module.exports=q(G);var r=require("@raycast/api"),d=require("react");var f=require("@raycast/api"),C="https://api.cloudflare.com/client/v4";function E(){let{apiToken:t}=(0,f.getPreferenceValues)();return{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}}async function Z(){try{let o=await(await fetch(`${C}/zones?per_page=50`,{method:"GET",headers:E()})).json();if(!o.success){let n=o.errors.map(i=>i.message).join(", ");throw new Error(n||"Failed to fetch zones")}return o.result}catch(t){throw console.error("Error fetching zones:",t),t}}async function z(t,o){if(o.length===0)throw new Error("No URLs provided");if(o.length>30)throw new Error("Maximum 30 URLs per request. Split into multiple batches.");try{let i=await(await fetch(`${C}/zones/${t}/purge_cache`,{method:"POST",headers:E(),body:JSON.stringify({files:o})})).json();if(!i.success){let s=i.errors.map(g=>g.message).join(", ");throw new Error(s||"Failed to purge URLs")}return!0}catch(n){throw console.error("Error purging URLs:",n),n}}function I(){let{defaultZoneId:t}=(0,f.getPreferenceValues)();return t}function b(t){try{return new URL(t).hostname}catch{return null}}async function L(t){let o=await Z(),n=o.find(s=>s.name===t);if(n)return n;let i=t.split(".");for(;i.length>1;){i.shift();let s=i.join(".");if(n=o.find(g=>g.name===s),n)return n}return null}async function h(t,o){await(0,f.showToast)({style:f.Toast.Style.Failure,title:t,message:o?.message})}async function F(t){await(0,f.showToast)({style:f.Toast.Style.Success,title:t})}var l=require("react/jsx-runtime");function $(){let[t,o]=(0,d.useState)(""),[n,i]=(0,d.useState)(""),[s,g]=(0,d.useState)([]),[D,T]=(0,d.useState)(!0),[j,x]=(0,d.useState)(!1),[A,m]=(0,d.useState)(),[w,p]=(0,d.useState)(null);(0,d.useEffect)(()=>{_()},[]),(0,d.useEffect)(()=>{t&&s.length>0&&O(t)},[t,s]);async function _(){T(!0);try{let e=await Z();g(e);let a=I();a&&i(a);let c=await r.Clipboard.readText();if(c){let u=c.trim();if(y(u)){o(u);let U=b(u);if(U){let P=await L(U);P&&(i(P.id),p(P))}}}}catch(e){await h("Failed to initialize",e instanceof Error?e:void 0)}finally{T(!1)}}function y(e){try{let a=new URL(e);return a.protocol==="http:"||a.protocol==="https:"}catch{return!1}}async function O(e){if(!y(e)){p(null);return}let a=b(e);if(!a){p(null);return}let c=s.find(u=>a.endsWith(u.name)||a===u.name);c&&c.id!==n?(p(c),i(c.id)):c||p(null)}function S(e){return e.trim()?y(e)?(m(void 0),!0):(m("Please enter a valid URL starting with http:// or https://"),!1):(m("URL is required"),!1)}async function k(e){if(!S(e.url))return;if(!e.zoneId){await h("Please select a zone");return}let a=s.find(u=>u.id===e.zoneId);if(!a){await h("Invalid zone selected");return}let c=b(e.url);if(c&&!c.endsWith(a.name)&&c!==a.name){m(`URL domain (${c}) doesn't match zone (${a.name})`);return}x(!0),await(0,r.showToast)({style:r.Toast.Style.Animated,title:"Purging URL..."});try{await z(e.zoneId,[e.url.trim()]),await F(`Purged: ${e.url}`),await(0,r.popToRoot)()}catch(u){await h("Failed to purge URL",u instanceof Error?u:void 0)}finally{x(!1)}}return(0,l.jsxs)(r.Form,{isLoading:D||j,actions:(0,l.jsxs)(r.ActionPanel,{children:[(0,l.jsx)(r.Action.SubmitForm,{title:"Purge URL",icon:{source:r.Icon.Trash,tintColor:r.Color.Red},onSubmit:k}),(0,l.jsx)(r.Action,{title:"Paste from Clipboard",icon:r.Icon.Clipboard,shortcut:{modifiers:["cmd","shift"],key:"v"},onAction:async()=>{let e=await r.Clipboard.readText();e&&y(e.trim())&&o(e.trim())}})]}),children:[(0,l.jsx)(r.Form.TextField,{id:"url",title:"URL to Purge",placeholder:"https://example.com/page-to-purge",value:t,onChange:e=>{o(e),e&&S(e)},error:A,info:"The exact URL to remove from Cloudflare's cache"}),(0,l.jsxs)(r.Form.Dropdown,{id:"zoneId",title:"Zone",value:n,onChange:i,info:w?`Auto-detected: ${w.name}`:"Select the Cloudflare zone for this URL",children:[(0,l.jsx)(r.Form.Dropdown.Item,{value:"",title:"Select a zone..."}),s.map(e=>(0,l.jsx)(r.Form.Dropdown.Item,{value:e.id,title:e.name,icon:e.status==="active"?{source:r.Icon.CheckCircle,tintColor:r.Color.Green}:{source:r.Icon.Circle,tintColor:r.Color.SecondaryText}},e.id))]}),w&&(0,l.jsx)(r.Form.Description,{title:"Auto-detected",text:`Zone "${w.name}" was automatically selected based on the URL domain.`}),(0,l.jsx)(r.Form.Description,{title:"Notes",text:`\u2022 URL must include the full path (https://...)
\u2022 Include query strings if the cached version has them
\u2022 Changes take effect within seconds globally`})]})}
